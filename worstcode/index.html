<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Le Clicker de l'Enfer</title>
    <style>
        body {
            background-color: #ff69b4;
            font-family: "Comic Sans MS", cursive;
        }
        .clicker-button {
            font-size: 48px;
            padding: 20px;
            background-color: lime;
            border: 5px solid magenta;
            cursor: pointer;
        }
        #compteurAffichage {
            font-size: 64px;
        }
        .data-container {
            margin-top: 20px;
        }
        .data-box {
            background-color: #32CD32;
            padding: 10px;
            margin: 10px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="compteurAffichage">Chargement...</div>
    <button id="clicker" class="clicker-button">Cliquer (si tu oses)</button>
    <button class="button" id="data-but">Charger les données</button>

    <div class="data-container" id="data-container"></div>

    <script>
        // Fonction asynchrone pour récupérer le nombre de lignes
        async function fetchRowCount() {
            try {
                const response = await fetch('get_row_count.php');
                const data = await response.json();
                return data.total_rows;  // Retourne le nombre total de lignes
            } catch (error) {
                console.error('Erreur AJAX:', error);
                return 0;  // Retourne 0 en cas d'erreur
            }
        }

        // Appel à loadData lorsque le bouton est cliqué
        document.getElementById('data-but').addEventListener('click', function() {
            loadData();
        });

        // Fonction pour charger les données
        async function loadData() {
            // Attendre que le nombre de lignes soit récupéré
            const totalRows = await fetchRowCount();
            console.log(`Total rows: ${totalRows}`);  // Affiche le nombre de lignes dans la console

            let colonnes = ['id', 'session_id', 'ip_address', 'user_agent', 'ancien_compteur', 'nouveau_compteur', 'update_time'];  // Noms des colonnes
            
            // Charger les données ligne par ligne, puis champ par champ
            for (let i = 0; i < totalRows; i++) {
                colonnes.forEach((colonne, index) => {
                    setTimeout(() => {
                        fetch(`get_field.php?rang=${i}&colonne=${colonne}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.value) {
                                    addDataToPage(i, colonne, data.value);
                                } else {
                                    console.error(`Erreur pour ligne ${i}, colonne ${colonne}: ${data.error}`);
                                }
                            })
                            .catch(error => console.error('Erreur AJAX:', error));
                    }, Math.random() * 1000); // Temps aléatoire pour un affichage chaotique
                });
            }
        }

        // Fonction pour ajouter les données sur la page
        function addDataToPage(rowIndex, columnName, value) {
            let container = document.getElementById('data-container');
            let dataBox = document.createElement('div');
            dataBox.classList.add('data-box');
            dataBox.innerHTML = `<strong>Row ${rowIndex + 1} - ${columnName}:</strong> ${value}`;
            container.appendChild(dataBox);
        }

        function fetchCompteur() {
            fetch('get_compteur.php')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('compteurAffichage').innerHTML = `<marquee>Compteur : ${data.compteur}</marquee>`;
                    
                    // Afficher l'historique
                    let historiqueHTML = '<ul>';
                    data.historique.forEach(function(entry) {
                        historiqueHTML += `<li>${entry.ancien_compteur} ➡️ ${entry.nouveau_compteur} à ${entry.update_time}</li>`;
                    });
                    historiqueHTML += '</ul>';
                    document.getElementById('historiqueAffichage').innerHTML = historiqueHTML;
                })
                .catch(error => console.error('Erreur:', error));
        }

        function incrementCompteur() {
            fetch('update_compteur.php')
                .then(response => response.text())
                .then(data => {
                    console.log("Compteur mis à jour : " + data);
                    fetchCompteur(); // Rafraîchir l'affichage après incrémentation
                })
                .catch(error => console.error('Erreur:', error));
        }

        document.getElementById('clicker').addEventListener('click', function() {
            incrementCompteur();
        });

        // Charger le compteur au démarrage
        fetchCompteur();
    </script>
</body>
</html>
